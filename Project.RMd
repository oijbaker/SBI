### SM2 / SC2 Project
# Using ABC/SIR to Model the Spread of Influenza in a Boarding School

First we will import the neceassary dataset.

```{r}
library(pomp)
library(Rcpp)
data(bsflu)
```

The dataset contains infomation about the spread of Influenza over a period of 14 days, in a boarding school of 763 students.

```{r}
head(bsflu)
```

'B' contains the number of students who are bedridden with the flue on a given day. C contains the number of students who are covalescent, that is, unable to return to class.

In order to model disease data, we will use the well-studied SIR model. This model models the number of people in three states: Susceptible, Infected, and Recovered. The model is defined by the following equations:
$$
\begin{align*}
\frac{dS}{dt} &= -\beta S I \\
\frac{dI}{dt} &= \beta S I - \gamma I \\
\frac{dR}{dt} &= \gamma I
\end{align*}
$$

Where $S$ is the number of susceptible individuals, $I$ is the number of infected individuals, and $R$ is the number of recovered individuals. $\beta$ is the rate of infection, and $\gamma$ is the rate of recovery.

In the interest of speed, we will implement the SIR model in C++, then use RCPP to call the C++ code from R.

```{r}
sourceCpp(code = "
  #include <Rcpp.h>
  using namespace Rcpp;

  // [[Rcpp::export]]
  NumericVector SIR(NumericVector s, NumericVector i, NumericVector r, double s0, double i0, double r0, double beta, double gamma) {
    s[0] = s0;
    i[0] = i0;
    r[0] = r0;

    for (int t = 1; t < s.size(); t++) {
      s[t] = s[t-1] - beta * s[t-1] * i[t-1];
      i[t] = i[t-1] + beta * s[t-1] * i[t-1] - gamma * i[t-1];
      r[t] = r[t-1] + gamma * i[t-1];
    }

    return i;
  }
")
```

To demonstrate the code, below we plot the number of infected individuals at starting conditions $s_0 = 500$, $i_0 = 1$, $r_0 = 0$, $\beta = 0.7$, $\gamma = 0.3$, over a period of 50 days.

```{r}
s <- numeric(50)
i <- numeric(50)
r <- numeric(50)

I <- SIR(s, i, r, 499/500, 1/500, 0, 0.7, 0.3)
plot(I, type="l", ylab="Proportion of Populaiton Infected",
     xlab="Day", ylim=c(0,1), col="red")
```

To perform ABC, we will need to compare the simualted data to the observed data. To do this, we will compare the number of infected individuals on each day. Specifically, we compare the B column of the dataset to the number of infected individuals I in the SIR model. 

Below we implement the ABC algorithm.

```{r}
sourceCpp(code = "#include <Rcpp.h>
#include <RcppParallel.h>
#include <omp.h>
using namespace Rcpp;

// [[Rcpp::depends(RcppParallel)]]
// [[Rcpp::plugins(openmp)]]

// Function to simulate data from SIR model
// [[Rcpp::export]]
NumericVector SIR(double s0, double i0, double r0, double beta, double gamma, int T) {
  double s[T];
  double i[T];
  double r[T];
  
  s[0] = s0;
  i[0] = i0;
  r[0] = r0;

  for (int t = 1; t < T; t++) {
    s[t] = s[t-1] - beta * s[t-1] * i[t-1];
    i[t] = i[t-1] + beta * s[t-1] * i[t-1] - gamma * i[t-1];
    r[t] = r[t-1] + gamma * i[t-1];
  }
  
  NumericVector i_return;
  
  for (int t = 1; t < T; t++) {
    i_return[t] = i[t];
  }

  return i_return;
}


// Function to calculate distance
double calc_dist(NumericVector x_sim, NumericVector x) {
  double total = 0;
  for (int i=0; i<x.size(); i++) {
    total += pow(x[i]-x_sim[i], 2);
  }
  return total;
}

// [[Rcpp::export]]
NumericMatrix ABC(int n, double eps, int p, NumericVector x, int ncores) {
  
  NumericMatrix accepted_samples;
  int count = 0;

  #pragma omp parallel num_threads(ncores)
  {
  
    NumericVector theta_sim(p);
    NumericVector x_sim(p);
    double dist;

    #pragma omp for
    for(int i = 0; i < n; i++) {
      theta_sim = runif(p, 0, 1); // sample from prior
      
      x_sim = SIR(762/763, 1/763, 0, theta_sim[1], theta_sim[2], 20); // simulate data from SIR model
      dist = calc_dist(x_sim, x); // calculate distance
    
      // Accept-reject step
      if(dist <= eps){
        for(int j = 0; j < p; j++) {
          accepted_samples(i, j) = theta_sim[j];
        }
        count++;
      }
    }

  }
  
  std::cout << count << std::endl;
  return accepted_samples;
  
}
")
```

```{r}
n <- 10
x <- bsflu$B / n
eps <- 20.0

ABC(n, eps, 2, x, 4)
```
